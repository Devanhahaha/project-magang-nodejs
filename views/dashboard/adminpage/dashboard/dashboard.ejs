<% var title="Dashboard" ; %>
<style>
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
  }

  .calendar-day {
    border: 1px solid #ddd;
    border-radius: 50%;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .calendar-day:hover {
    background: linear-gradient(145deg, #f0f4f8, #dbe9f4);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .calendar-day.today {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  .calendar-day .badge {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background: #ffc107;
    color: #000;
    font-size: 10px;
    border-radius: 8px;
    padding: 2px 6px;
    animation: pulse 1s infinite alternate;
  }

  @keyframes pulse {
    from {
      transform: scale(1);
    }

    to {
      transform: scale(1.1);
    }
  }

  /* Modal Event Custom Style */
  .modal-content {
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  .event-label {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    color: #fff;
  }

  .label-business {
    background: #007bff;
  }

  .label-hooliday {
    background: #28a745;
  }

  .label-personal {
    background: #dc3545;
  }
</style>

<div class="container-fluid flex-grow-1 container-p-y">
  <div class="row g-6">
    <!-- News Card -->
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-info text-uppercase mb-1"
              >
                News
              </div>
              <div class="row no-gutters align-items-center">
                <div class="col-auto">
                  <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">
                    <%= totalNews %>
                  </div>
                </div>
                <div class="col">
                  <div class="progress progress-sm mr-2">
                    <div
                      class="progress-bar bg-info"
                      role="progressbar"
                      style="width: <%= (persenNews || 0) %>%"
                      aria-valuenow="<%= persenNews %>"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Portfolio Card -->
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-info text-uppercase mb-1"
              >
                Portfolio
              </div>
              <div class="row no-gutters align-items-center">
                <div class="col-auto">
                  <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">
                    <%= totalPortofolio %>
                  </div>
                </div>
                <div class="col">
                  <div class="progress progress-sm mr-2">
                    <div
                      class="progress-bar bg-info"
                      role="progressbar"
                      style="width: <%= persenPortofolio || 0 %>%"
                      aria-valuenow="<%= persenPortofolio %>"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Card -->
    <div class="col-xl-4 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-info text-uppercase mb-1"
              >
                Services
              </div>
              <div class="row no-gutters align-items-center">
                <div class="col-auto">
                  <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">
                    <%= totalServices %>
                  </div>
                </div>
                <div class="col">
                  <div class="progress progress-sm mr-2">
                    <div
                      class="progress-bar bg-info"
                      role="progressbar"
                      style="width: <%= persenServices || 0 %>%"
                      aria-valuenow="<%= persenServices %>"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Welcome Card -->
    <div class="col-12">
      <div class="card">
        <div class="d-flex align-items-end row">
          <div class="col-7">
            <div class="card-body text-nowrap">
              <h5 class="card-title mb-0">Welcome <%= user.name %>!üéâ</h5>
              <p class="mb-2">Hope you're having a productive day ‚òÄÔ∏è</p>
              <p class="mb-2">It's <%= currentDate %> ‚Äî let's make it count!</p>
              <a href="/portofolio" class="btn btn-primary">Check Activities</a>
            </div>
          </div>
          <div class="col-5 text-center text-sm-left">
            <div class="card-body pb-0 px-0 px-md-4">
              <img
                src="/dashboard/admin/assets/img/illustrations/card-advance-sale.png"
                height="140"
                alt="view sales"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Charts -->
    <div class="col-xxl-12 col-12">
      <div class="row g-4">
        <div class="col-xl-6 col-md-6">
          <div class="card h-100">
            <div class="card-header pb-0">
              <h5 class="card-title mb-1">Profit</h5>
              <p class="card-subtitle">Jumlah Pengunjung</p>
            </div>
            <div class="card-body">
              <canvas id="profitLastMonth"></canvas>
              <div
                class="d-flex justify-content-between align-items-center mt-3 gap-3"
              >
                <h4 class="mb-0"><%= totalVisitor %> Pengunjung</h4>
                <small class="text-success"><%= growth %>%</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-6 col-md-6">
          <div class="card h-100">
            <div class="card-header pb-2">
              <h5 class="card-title mb-1"><%= totalVisitor %> Pengunjung</h5>
              <p class="card-subtitle">Expenses Jumlah Pengunjung</p>
            </div>
            <div class="card-body">
              <canvas id="expensesChart"></canvas>
              <div class="mt-3 text-center">
                <small class="text-muted mt-3"><%= growth %>%</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 mt-4">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="card-title mb-0">Calendar <%= currentDate %></h5>
        <button
          class="btn btn-sm btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addEventModal"
        >
          Add Event
        </button>
      </div>
      <div class="card-body">
        <div id="simpleCalendar" class="calendar-grid"></div>
      </div>
    </div>
  </div>
  <div
    class="modal fade"
    id="addEventModal"
    tabindex="-1"
    aria-labelledby="addEventModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form action="/calendar/store" method="POST" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addEventModalLabel">Add Event</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="eventTitle" class="form-label">Title</label>
            <input
              type="text"
              class="form-control"
              id="eventTitle"
              name="title"
              required
            />
          </div>
          <div class="mb-5">
            <label class="form-label" for="eventLabel">Label</label>
            <select
              class="select2 select-event-label form-select"
              id="label"
              name="label"
            >
              <option data-label="primary" value="business" selected>
                Business
              </option>
              <option data-label="danger" value="personal">Personal</option>
              <option data-label="success" value="hooliday">Hooliday</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="eventStart" class="form-label">Start Date</label>
            <input
              type="date"
              class="form-control"
              id="eventStart"
              name="start_date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">End Date</label>
            <input
              type="date"
              class="form-control"
              id="eventEnd"
              name="end_date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">Event Url</label>
            <input
              type="text"
              class="form-control"
              id="event_url"
              name="event_url"
              required
            />
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">Guest</label>
            <input
              type="text"
              class="form-control"
              id="guest"
              name="guest"
              required
            />
          </div>
          <div class="mb-3">
            <label for="eventEnd" class="form-label">Location</label>
            <input
              type="text"
              class="form-control"
              id="location"
              name="location"
              required
            />
          </div>
          <div class="mb-3">
            <label for="eventDesc" class="form-label" for="description"
              >Description</label
            >
            <textarea
              class="form-control"
              id="description"
              name="description"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Event</button>
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  <div
    class="modal fade"
    id="editEventModal"
    tabindex="-1"
    aria-labelledby="editEventModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form id="editEventForm" action="" method="POST" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editEventTitle" class="form-label">Title</label>
            <input
              type="text"
              class="form-control"
              id="editEventTitle"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editLabel" class="form-label">Label</label>
            <select class="form-select" id="editLabel" name="label">
              <option value="business">Business</option>
              <option value="personal">Personal</option>
              <option value="hooliday">Hooliday</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editStartDate" class="form-label">Start Date</label>
            <input
              type="date"
              class="form-control"
              id="editStartDate"
              name="start_date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editEndDate" class="form-label">End Date</label>
            <input
              type="date"
              class="form-control"
              id="editEndDate"
              name="end_date"
              required
            />
          </div>
          <div class="mb-3">
            <label for="editEventUrl" class="form-label">Event URL</label>
            <input
              type="text"
              class="form-control"
              id="editEventUrl"
              name="event_url"
            />
          </div>
          <div class="mb-3">
            <label for="editGuest" class="form-label">Guest</label>
            <input
              type="text"
              class="form-control"
              id="editGuest"
              name="guest"
            />
          </div>
          <div class="mb-3">
            <label for="editLocation" class="form-label">Location</label>
            <input
              type="text"
              class="form-control"
              id="editLocation"
              name="location"
            />
          </div>
          <div class="mb-3">
            <label class="form-label" for="editDescription">Description</label>
            <textarea
              id="editDescription"
              name="description"
              class="form-control"
              required
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update Event</button>
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  <div
    class="modal fade"
    id="viewEventsModal"
    tabindex="-1"
    aria-labelledby="viewEventsModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewEventsModalLabel">
            Events on <span id="viewDate"></span>
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body" id="eventList">
          <!-- Events will be injected here -->
        </div>
      </div>
    </div>
  </div>
</div>
<form id="delete-form" method="POST" style="display: none"></form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmDelete(id) {
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.getElementById("delete-form");
        form.action = `/calendar/delete/${id}`;
        form.submit();
      }
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<% if (error) { %>
<script>
  Swal.fire({
    icon: "error",
    title: "Gagal!",
    text: "<%= error %>",
    showConfirmButton: false,
    timer: 2000,
  });
</script>
<% } %> <% if (success) { %>
<script>
  Swal.fire({
    icon: "success",
    title: "Berhasil!",
    text: "<%= success %>",
    showConfirmButton: false,
    timer: 2000,
  });
</script>
<% } %>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const calendar = document.getElementById("simpleCalendar");
    calendar.innerHTML = "";

    try {
      const res = await fetch("/calendar/all");
      const events = await res.json();

      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        calendar.innerHTML += `<div></div>`;
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(
          day
        ).padStart(2, "0")}`;
        const dayEvents = events.filter((e) => {
          const eventDate = new Date(e.start_date).toLocaleDateString("sv-SE", {
            timeZone: "Asia/Jakarta",
          }); // sv-SE gives YYYY-MM-DD
          return eventDate === dateStr;
        });
        calendar.innerHTML += `
                  <div class="calendar-day" onclick="openEventsModal('${dateStr}')">
                    <strong>${day}</strong>
                    ${
                      dayEvents.length > 0
                        ? `<span class="badge">${dayEvents.length}</span>`
                        : ""
                    }
                  </div>`;
      }
    } catch (err) {
      console.error("Failed to fetch events:", err);
    }
  });
  function openEventsModal(date) {
    fetch(`/calendar/all`)
      .then((res) => res.json())
      .then((events) => {
        const dayEvents = events.filter(
          (e) =>
            new Date(e.start_date).toLocaleDateString("sv-SE", {
              timeZone: "Asia/Jakarta",
            }) === date
        );

        const eventList = document.getElementById("eventList");
        const viewDate = document.getElementById("viewDate");

        viewDate.textContent = date;

        if (dayEvents.length === 0) {
          eventList.innerHTML = `<p class="text-muted">No events on this day.</p>`;
        } else {
          eventList.innerHTML = dayEvents
            .map(
              (e) => `
          <div class="border-bottom py-2">
            <span class="event-label label-${e.label}">${e.label}</span>
            <h6 class="mb-1">${e.title}</h6>
            <p class="mb-1">${e.description || "No description"}</p>
            <small>
              üìÖ ${new Date(e.start_date).toLocaleDateString("id-ID")} - 
              ${new Date(e.end_date).toLocaleDateString("id-ID")}
            </small><br>
            <small>üë§ ${e.guest}</small><br>
            <small>üìç ${e.location}</small><br>
            <small>üîó <a href="${e.event_url}" target="_blank">${
                e.event_url
              }</a></small><br>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-warning" onclick="openEditEventModal(${
                e.id
              })">
                <i class="ti ti-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="confirmDelete(${
                e.id
              })">
                <i class="ti ti-trash"></i> Delete
              </button>
            </div>
          </div>
            `
            )
            .join("");
        }

        const viewModal = new bootstrap.Modal(
          document.getElementById("viewEventsModal")
        );
        viewModal.show();
      });
  }
  function openEditEventModal(id) {
    fetch(`/calendar/all`)
      .then((res) => res.json())
      .then((events) => {
        const event = events.find((e) => e.id == id);
        if (event) {
          // Set form action dan isi form
          document.getElementById(
            "editEventForm"
          ).action = `/calendar/update/${id}`;
          document.getElementById("editEventTitle").value = event.title;
          document.getElementById("editLabel").value = event.label;
          document.getElementById("editStartDate").value = event.start_date; // TANPA jam
          document.getElementById("editEndDate").value = event.end_date; // TANPA jam
          document.getElementById("editEventUrl").value = event.event_url;
          document.getElementById("editGuest").value = event.guest;
          document.getElementById("editLocation").value = event.location;
          document.getElementById("editDescription").value = event.description;

          // Tutup modal viewEventsModal dulu
          const viewModalEl = document.getElementById("viewEventsModal");
          const viewModal = bootstrap.Modal.getInstance(viewModalEl);
          if (viewModal) {
            viewModal.hide();
          }

          // Buka modal edit
          const editModalEl = document.getElementById("editEventModal");
          const editModal = new bootstrap.Modal(editModalEl);
          editModal.show();
        } else {
          console.error("Event not found with id:", id);
        }
      })
      .catch((err) => {
        console.error("Failed to fetch event data:", err);
      });
  }
</script>
<script src="https://cdn.ckeditor.com/4.22.1/standard-all/ckeditor.js"></script>
<script>
  // Pasang CKEditor hanya saat modal dibuka
  document.addEventListener("shown.bs.modal", function (e) {
    const textarea = e.target.querySelector("textarea");
    if (textarea) {
      if (CKEDITOR.instances[textarea.id]) {
        CKEDITOR.instances[textarea.id].destroy(true);
      }
      CKEDITOR.replace(textarea.id);
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const ctxProfit = document.getElementById('profitLastMonth').getContext('2d');
  const profitChart = new Chart(ctxProfit, {
    type: 'line',
    data: {
      labels: <%- JSON.stringify(dailyLabels) %>,
      datasets: [{
        label: 'Pengunjung',
        data: <%- JSON.stringify(dailyCounts) %>,
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>
<script>
  const ctxExpenses = document.getElementById('expensesChart').getContext('2d');
  const expensesChart = new Chart(ctxExpenses, {
    type: 'doughnut',
    data: {
      labels: ['Pengunjung', 'Sisa'],
      datasets: [{
        data: [<%= totalVisitor %>, <%= 100 - totalVisitor %>],
        backgroundColor: ['#36A2EB', '#E0E0E0'],
        hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        }
      }
    }
  });
</script>
